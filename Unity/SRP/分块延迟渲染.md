# åˆ†å—å»¶è¿Ÿæ¸²æŸ“

æœ€è¿‘å°è¯•åœ¨SRPä¸­å®ç°ä¸€ä¸‹Tile based Deferred Shading(åˆ†å—å»¶è¿Ÿæ¸²æŸ“)åŠŸèƒ½ã€‚

é¦–å…ˆåˆ—ä¸€ä¸‹åˆ†å—å»¶è¿Ÿæ¸²æŸ“çš„æµæ°´çº¿:

- æ¸²æŸ“ä¸€éåœºæ™¯ç”ŸæˆGBuffer
- å¯¹å±å¹•è¿›è¡Œåˆ†å—(ä¾‹å¦‚16x16/32x32 pixel)ï¼Œä»è¿™äº›Tileå‡ºå‘ï¼Œå¯ä»¥å°†è§†é”¥åˆ†å‰²æˆç›¸åŒæ•°ç›®çš„å­è§†é”¥
- å°†åœºæ™¯ç¯å…‰åŒ…å›´ç›’ä¸Tileå¯¹åº”çš„å­è§†é”¥è¿›è¡Œç›¸äº¤æµ‹è¯•ï¼Œå»ºç«‹èµ·æ¯ä¸ªTileå¯¹åº”çš„ç¯å…‰ç´¢å¼•åˆ—è¡¨
- åœ¨æœ€åçš„LightPassä¸­ï¼Œè¯»å–GBufferä¸­çš„ä¿¡æ¯ã€ä»¥åŠåƒç´ å¯¹åº”çš„ç¯å…‰ä¿¡æ¯ï¼Œè¿›è¡Œå…‰ç…§ç€è‰²è®¡ç®—

ä¹Ÿå³:

```text
Rendering G-Buffer -> Tile Light Culling -> Light Pass
```

æœ¬æ–‡ä¼šåˆ†å‡ ä¸ªéƒ¨åˆ†è®¨è®º:

1. G-Bufferçš„ç”Ÿæˆå’ŒNormalçš„Pack
2. LightPassè¿›è¡Œå…‰ç…§ç€è‰²
3. ä½¿ç”¨ComputeShaderå®ç°å±å¹•åˆ†å—å…‰æºå‰”é™¤(åªè€ƒè™‘PointLight)
4. å®ç°è¿‡ç¨‹ä¸­çš„ä¸€äº›ç–‘é—®

å…ˆæ”¾ä¸ªåŠ¨å›¾å§ï¼ŒGifå‹çš„å¾ˆæ®‹ï¼Œå°±è¡¨è¾¾ä¸ªæ„æ€ã€‚è¿™é‡Œæ”¾äº†256ç›Point Light.

![åŠ¨å›¾å°é¢](https://pic1.zhimg.com/v2-120ab2a2c94a9788d31b74eac783592c_b.jpg)



## 1. Rendering G-Buffer

G-Bufferå®é™…ä¸Šç”±å¤šå¼ RenderTextureæ„æˆï¼Œæ¯å¼ RTä¸­å­˜å‚¨çš„æ•°æ®é€šå¸¸è¦æ ¹æ®åæœŸç€è‰²çš„éœ€æ±‚è¿›è¡Œå¡«å……ï¼Œä½†å¤§è‡´ä¼šåŒ…æ‹¬Normalã€Albedoã€‚å¦‚æœæ˜¯PBRå…‰ç…§æ¨¡å‹çš„è¯ï¼Œè¿˜ä¼šåŒ…æ‹¬Metalness, Roughnessç­‰ç­‰ã€‚

ä¸ºäº†èƒ½åœ¨ä¸€ä¸ªPassä¸­ï¼ŒæŠŠè¿™ä¹ˆå¤šæ•°æ®åŒæ—¶æ¸²æŸ“åˆ°å¤šå¼ RTä¸­ï¼Œå°±éœ€è¦GPUæ”¯æŒMRT(Multiple Render Targets)è¿™ä¸ªåŠŸèƒ½ã€‚

åœ¨Unityä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `SystemInfo.supportedRenderTargetCount`æ¥ç¡®å®šè®¾å¤‡æ˜¯å¦æ”¯æŒæˆ‘ä»¬æ‰€éœ€è¦çš„MRTã€‚

å½“ç„¶ä¹Ÿæœ‰äººå°è¯•æŠŠæ‰€æœ‰çš„æ•°æ®å‹ç¼©åˆ°ä¸€å¼ RTé‡Œï¼Œè¿™æ ·å°±ä¸å†éœ€è¦MRTçš„æ”¯æŒï¼Œä½†æ˜¯æœ€ç»ˆæ•ˆæœå¦‚ä½•åªèƒ½å®é™…æµ‹è¯•çœ‹æ•ˆæœäº†ã€‚

åœ¨SRPä¸­è®¾ç½®MRTæ¯”è¾ƒç®€å•ï¼Œåªè¦ç”³è¯·å¤šå¼ ç›¸åº”æ ¼å¼çš„RTï¼Œç„¶åé€šè¿‡æ¥å£

```csharp
CommandBuffer.SetRenderTarget(RenderTargetIdentifier[] colors, RenderTargetIdentifier depth);
```

è¿›è¡Œè®¾ç½®å³å¯ã€‚

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œå¯¹-GBufferçš„è§„åˆ’å¦‚ä¸‹:

æ™®é€šæ¨¡å¼:

```text
G-Buffer1 - |Albedo(24bit)|metalness(8bit)|
G-Buffer2 - |Normal(24bit)|roughness(8bit)|
```

é«˜ç²¾åº¦æ³•çº¿æ¨¡å¼:

```text
G-Buffer1 - |Albedo(24bit)|metalness(8bit)|
G-Buffer2 - |PackedNormal(32bit)|
G-Buffer3 - |æš‚æ— ç”¨(24bit)|roughness(8bit)|
```

å¯ä»¥çœ‹å‡ºç°åœ¨æ•°æ®è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼ŒåæœŸæ ¹æ®æ¸²æŸ“éœ€æ±‚å¯èƒ½è¿˜è¦å¢åŠ AOã€Emissiveç­‰æ•°æ®ã€‚GBufferä¸­æ²¡æœ‰Positionæ•°æ®ï¼Œå› ä¸ºPositionåœ¨åæœŸå¯ä»¥é€šè¿‡Depthå’ŒUVé‡å»ºå‡ºæ¥ã€‚

G-Buffer Passçš„Shaderå®ç°ä¹Ÿæ˜¯éå¸¸ç®€å•çš„ï¼Œé¦–å…ˆå®šä¹‰Fragçš„è¾“å‡ºç»“æ„ã€‚

```text
struct GBufferOutput
{
    half4 GBuffer0 : SV_Target0;
    half4 GBuffer1 : SV_Target1;
    half4 GBuffer2 : SV_Target2;
    half4 GBuffer3 : SV_Target3;
};
```

ç„¶ååœ¨ç‰‡æ®µç€è‰²å™¨é‡Œï¼Œè¯»å–ç‰©ä½“çš„å„ç§å±æ€§ï¼Œå¡«å……å…¥GBufferOutputå³å¯ã€‚

ä¾‹å¦‚GBuffer0çš„å¡«å……ä»£ç å¦‚ä¸‹:

```text
GBufferOutput o;
o.GBuffer0 = half4(pbrInput.albedo,pbrInput.metalness);
```

## 1.1 æ³•çº¿å‹ç¼©

å¾€GBufferä¸­å¡«å……æ³•çº¿ä¿¡æ¯çš„æ—¶å€™ï¼Œæœ€ç›´æ¥çš„ä¸€ç§æ–¹å¼è‡ªç„¶æ˜¯xyzä¸‰ä¸ªåˆ†é‡å„ç”¨8bitå­˜å‚¨ã€‚è½¬æ¢å…¬å¼å¦‚ä¸‹:

```text
///å°†normalåˆ†é‡ä»[-1,1]æ˜ å°„åˆ°[0,1]
static half3 PackNormal(half3 normalWS){
    return normalWS * 0.5 + 0.5;
}

//å°†cçš„åˆ†é‡ä»[0,1]æ˜ å°„åˆ°[-1,1]
static half3 UnpackNormal(half3 c){
    return c * 2 - 1;
}
```

è¿™ç§æ–¹å¼è™½ç„¶ç®€å•ï¼Œä½†æ˜¯æ¯ä¸ªåˆ†é‡åªèƒ½è¡¨è¾¾256é˜¶ï¼Œæ³•çº¿ç²¾åº¦æ˜¯å¾ˆå·®çš„ã€‚åœ¨å®é™…çš„æ¸²æŸ“æ•ˆæœé‡Œï¼Œé«˜å…‰æ•ˆæœä¼šæœ‰å¾ˆæ˜æ˜¾çš„å—çŠ¶ç°è±¡ï¼Œå¦‚ä¸‹:

![img](https://pic4.zhimg.com/80/v2-ebeeb0575964f21978b8fdc6c9624b97_720w.webp)

Pack Normal use RGB24 directly

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œäººä»¬æƒ³äº†å¾ˆå¤šç®—æ³•æ¥æŠŠæ³•çº¿ä¿¡æ¯ä»¥å°½é‡é«˜ç²¾åº¦çš„æ–¹å¼å­˜å‚¨åˆ°æœ‰é™çš„GBufferä¸­ã€‚åœ¨[[1\]A Survey of Efficient Representations for Independent Unit Vectors, 2014](https://link.zhihu.com/?target=http%3A//jcgt.org/published/0003/02/01/paper.pdf)è¿™ç¯‡paperä¸­ï¼Œåˆ—ä¸¾äº†å¾ˆå¤šç§æ³•çº¿æ˜ å°„ç®—æ³•ï¼Œæ¯”å¯¹æµ‹è¯•äº†å®ƒä»¬çš„è¯¯å·®ä»¥åŠEncode/Decodeæ€§èƒ½ï¼Œå€¼å¾—ä¸€çœ‹ã€‚ä½œè€…æœ€åå¾—å‡ºçš„ç»“è®ºæ˜¯Octæ˜ å°„å’ŒSphericalæ˜ å°„æ˜¯æ¯”è¾ƒå¥½çš„ç®—æ³•ã€‚å› æ­¤è¿™é‡Œç€é‡è¯´ä¸€ä¸‹Octæ˜ å°„ç®—æ³•ï¼Œæœ¬Demoä¹Ÿä¼šç”¨æ­¤ç®—æ³•æ¥å®ç°ã€‚

Octæ³•çº¿æ˜ å°„ç®—æ³•ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤ºå¦‚ä¸‹:

![img](https://pic1.zhimg.com/80/v2-1d2cf1bcef2c1ebf4ddbc263afdbf2c4_720w.webp)

From [1]

æˆ‘ä»¬ç”¨å•ä½çƒé¢ä¸Šçš„ä¸€ä¸ªç‚¹æ¥è¡¨ç¤ºä¸€ä¸ªå•ä½æ–¹å‘å‘é‡ã€‚ç¬¬ä¸€æ­¥å…ˆå°†è¿™ä¸ªç‚¹æ˜ å°„åˆ°ä¸€ä¸ªå…«é¢ä½“ä¸Šã€‚å‡è®¾pä¸ºçƒé¢ä¸Šçš„ç‚¹ï¼Œvä¸ºå…¶æ˜ å°„åˆ°å…«é¢ä½“ä¸Šçš„ç‚¹ï¼Œé‚£ä¹ˆå®ƒä»¬æ»¡è¶³æ˜ å°„å…¬å¼å¦‚ä¸‹:

ğ‘£=ğ‘|ğ‘.ğ‘¥|+|ğ‘.ğ‘¦|+|ğ‘.ğ‘§|

ç¬¬äºŒæ­¥æ˜¯å°†å…«é¢ä½“ä¸Šçš„ç‚¹æ˜ å°„åˆ°ä¸€ä¸ª2x2çš„æ­£æ–¹å½¢å†…ï¼Œè¿™ä¸€æ­¥å¯ä»¥æƒ³è±¡æˆæ˜¯UVå±•å¼€ã€‚å¾ˆæ˜æ˜¾(è¿™é‡Œæˆ‘ä»¬è§†zè½´æœä¸Š)ï¼Œå½“`v.z` > 0æ—¶ï¼Œ`v.xy`å°±æ˜¯æ­£æ–¹å½¢å†…çš„æ˜ å°„åæ ‡(æƒ³è±¡æˆæŠŠå…«é¢ä½“ä¸ŠåŠéƒ¨åˆ†æ‹å¹³åˆ°xyå¹³é¢ä¸Š)ã€‚è€Œå…«é¢ä½“çš„ä¸‹åŠéƒ¨åˆ†ï¼Œå³`v.z < 0`æ—¶ï¼Œåˆ™æŒ‰å¯¹è§’çº¿ç¿»è½¬åˆ°å¤–ä¾§ã€‚

å‡è®¾æ­£æ–¹å½¢å†…çš„æ˜ å°„ç‚¹ä¸ºwï¼Œé‚£ä¹ˆvå’Œwæ»¡è¶³æ˜ å°„å…¬å¼å¦‚ä¸‹:

```text
if(v.z > 0){
    w = v.xy;
}else{
    half2 signValue = (v.xy > 0? 1:-1);
    w = (1 - abs(v.yx)) * signValue;
}
```

æ³¨æ„æ ¹æ®v.xyæ­£è´Ÿå·çš„ä¸åŒï¼ŒsignValueæœ‰`(1,1),(1,-1),(-1,1),(-1,-1)`å››ç§æƒ…å†µï¼Œå¯¹åº”äº†å››ä¸ªè±¡é™çš„å±•å¼€ã€‚

ä»¥ä¸Šæ˜ å°„å…¬å¼å®é™…ä¸Šå¯ä»¥ç»™å‡ºæ›´è¯¦å°½çš„æ¨å¯¼è¿‡ç¨‹ï¼Œä»¥åæœ‰ç©ºå†ä¸“é—¨å¼€ä¸€ç¯‡å†™å¥½äº†ã€‚è¿™é‡Œç»™å‡ºå®Œæ•´çš„Encodeå’ŒDecodeä»£ç :

```text
static half2 PackNormalOct(half3 normalWS){
    half l = dot(abs(normalWS),1); //l = abs(x) + abs(y) + abs(z)
    half3 normalOct = normalWS * rcp(l); //æŠ•å½±åˆ°å…«é¢ä½“
    if(normalWS.z > 0){ //å…«é¢ä½“çš„ä¸Šéƒ¨åˆ†æŠ•å½±åˆ°xyå¹³é¢
        return normalOct.xy; 
    }else{ //å…«é¢ä½“ä¸‹éƒ¨åˆ†æŒ‰å¯¹è§’çº¿ç¿»è½¬æŠ•å½±åˆ°xyå¹³é¢
        return (1 - abs(normalOct.yx)) * SignNotZero(normalOct.xy);
    }
}

static half3 UnpackNormalOct(half2 e){
    half3 v = half3(e.xy,1 - abs(e.x) - abs(e.y));
    if(v.z <= 0){
        v.xy = SignNotZero(v.xy) *(1 - abs(v.yx));
    } 
    return normalize(v);
}
```

ä¸Šé¢çš„ä»£ç è¿˜å¯ä»¥æ”¹å†™æˆæ€§èƒ½æ›´å¥½(ä½†é˜…è¯»æ€§æ›´å·®)çš„ç‰ˆæœ¬ï¼Œä½†æœ¬é¡¹ç›®ä»¥å­¦ä¹ æ€è·¯ä¸ºä¸»ï¼Œå› æ­¤ä¼˜å…ˆç…§é¡¾å¯è¯»æ€§ã€‚

ä½¿ç”¨Octæ˜ å°„ï¼Œæ³•çº¿ä¿¡æ¯è¢«æ˜ å°„åˆ°ä¸¤ä¸ªåˆ†é‡ã€‚æˆ‘ä»¬å¯ä»¥ç”¨`16+16 = 32bit`æ¥ä¿å­˜è¿™ä¸¤ä¸ªåˆ†é‡(å¯¹åº”çš„GBufferæ ¼å¼ä¸ºRG32)ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`12+12=24bit`æ¥ä¿å­˜è¿™ä¸¤ä¸ªåˆ†é‡(éœ€è¦æ‰‹åŠ¨Packåˆ°RGBåˆ†é‡ä¸­)ã€‚æœ¬é¡¹ç›®ç›´æ¥ä½¿ç”¨äº†32bitæ¥ä¿å­˜ã€‚

é«˜ç²¾åº¦çš„æ³•çº¿é«˜å…‰æ•ˆæœï¼Œå¦‚ä¸èˆ¬é¡ºæ»‘:

![img](https://pic3.zhimg.com/80/v2-bbdc20a60c958e9e3cc18b3b79c768e6_720w.webp)

Pack Normal use Oct32

## 1.2 G-Buffer Debug Rendering

åœ¨G-Bufferå¡«å……å®Œæ¯•ä¹‹åï¼Œä¸ºäº†æµ‹è¯•G-Buffer Encodeå’ŒDecodeçš„æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå®ç°ä¸€ä¸ªDebugPassï¼Œå°†G-Bufferä¸­ä¿å­˜çš„ä¿¡æ¯Decodeå‡ºæ¥ï¼Œæ¯ä¸ªåˆ†é‡å•ç‹¬æ¸²æŸ“åˆ°ç”»é¢ä¸Šè¿›è¡ŒDebugã€‚

ä¾‹å¦‚æµ‹è¯•åœºæ™¯çš„Albedoä¿¡æ¯è¾“å‡ºå¦‚ä¸‹:

![img](https://pic4.zhimg.com/80/v2-40e995bea6e8c66c5b462b31564199af_720w.webp)

Albedo

Normalä¿¡æ¯å¦‚ä¸‹

![img](https://pic3.zhimg.com/80/v2-a3d4f19346745a34e0343910597016ba_720w.webp)

Normal

Metalness:

![img](https://pic1.zhimg.com/80/v2-986d577fdcb8ea11c095929afdc4e5ec_720w.webp)

metalness

è¿˜roughness, positionç­‰ç­‰å°±ä¸è´´äº†ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨LightPassä¸­ï¼Œåˆ©ç”¨Gbufferä¸­çš„è¿™äº›æ•°æ®ï¼Œæ¥è®¡ç®—å…‰ç…§ç€è‰²ã€‚

## 2. LightPass

æˆ‘ä»¬é€šå¸¸å¾€å…¨å±ç»˜åˆ¶ä¸€ä¸ªæ–¹å—æ¥å¼€å§‹Light Passé˜¶æ®µç€è‰²ã€‚ åœ¨SRPä¸­å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å‘å…¨å±ç»˜åˆ¶ä¸€ä¸ªæ–¹å—:

```csharp
public void Execute(ScriptableRenderContext context){
    if(!_lightPassMat){
        _lightPassMat = new Material(Shader.Find("Hidden/SRPLearn/DeferredLightPass"));
    }
    if(!_fullScreenMesh){
        _fullScreenMesh = Utils.CreateFullscreenMesh();
    }
    _commandbuffer.Clear();
    _commandbuffer.SetViewProjectionMatrices(Matrix4x4.identity,Matrix4x4.identity);
    _commandbuffer.DrawMesh(_fullScreenMesh,Matrix4x4.identity,_lightPassMat,0,0);
    context.ExecuteCommandBuffer(_commandbuffer);
}
```

_lightPassMatä¸ºLightPassé˜¶æ®µè¦ä½¿ç”¨çš„æè´¨ã€‚

## 2.1 å¹³è¡Œå…‰ç€è‰²è®¡ç®—

åœ¨Deferred Shadingé‡Œï¼Œå¹³è¡Œå…‰çš„å®ç°æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå› ä¸ºå®ƒä¼šå½±å“å±å¹•ä¸­çš„æ‰€æœ‰åƒç´ ï¼Œå› æ­¤ä¹Ÿå°±æ— éœ€è€ƒè™‘ç¯å…‰è£å‰ªä¹‹ç±»çš„ã€‚

åœ¨Light Pass Shaderçš„Fragä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆä»G-Bufferä¸­æå–PBRæ¸²æŸ“éœ€è¦çš„æ•°æ®:

```text
float2 uv = input.uv;
float depth = _XDepthTexture.Sample(sampler_pointer_clamp,input.uv).x;
half4 g0 =  _GBuffer0.Sample(sampler_pointer_clamp,input.uv);
half4 g1 =  _GBuffer1.Sample(sampler_pointer_clamp,input.uv);
half4 g2 =  _GBuffer2.Sample(sampler_pointer_clamp,input.uv);
half4 g3 =  _GBuffer3.Sample(sampler_pointer_clamp,input.uv);
PBRShadeInput shadeInput;
float3 positionWS = ReconstructPositionWS(uv,depth);
shadeInput.positionWS = positionWS;
DecodeGBuffer(shadeInput,g0,g1,g2,g3);
```

ç„¶åæ‹¿åˆ°å¹³è¡Œå…‰çš„æ•°æ®ï¼Œåªéœ€è¦æ–¹å‘å’Œé¢œè‰²(è¿™é‡Œè¿˜åŠ å…¥äº†é˜´å½±è®¡ç®—):

```text
ShadeLightDesc mainLightDesc = GetMainLightShadeDescWithShadow(shadeInput.positionWS,shadeInput.normal);
```

ç„¶åè¿›è¡Œæ ‡å‡†çš„PBRç€è‰²å°±å¯ä»¥äº†ã€‚

```text
//ç€è‰²ç‚¹å‡ ä½•ä¿¡æ¯
DECLARE_SHADE_POINT_DESC(sPointDesc,shadeInput);
//pbræè´¨ç›¸å…³
DECLARE_PBR_DESC(pbrDesc,shadeInput);
//å¹³è¡Œå…‰
ShadeLightDesc mainLightDesc = GetMainLightShadeDescWithShadow(shadeInput.positionWS,shadeInput.normal);
color = PBRShading(pbrDesc,sPointDesc,mainLightDesc);
```

![img](https://pic3.zhimg.com/80/v2-c32b595e476db40027d5a72686975ff6_720w.webp)

Deferred Shading LightPasså®ç°å¹³è¡Œå…‰

## 2.2 ç‚¹å…‰æºç€è‰²åˆæ­¥æ¢è®¨

å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬ä¸èƒ½å°†æ‰€æœ‰çš„åƒç´ å’Œæ‰€æœ‰çš„ç‚¹å…‰æºè¿›è¡Œä¸€ä¸€å¯¹æ¯”è®¡ç®—ã€‚å› ä¸ºç‚¹å…‰æºçš„å½±å“èŒƒå›´é€šå¸¸æ˜¯æœ‰é™çš„ï¼Œå®ƒåªèƒ½ç…§äº®å±€éƒ¨çš„åƒç´ ã€‚å¦‚æœå°†å…¨å±çš„åƒç´ éƒ½ä¸å…¶åšæ¯”è¾ƒï¼Œä¸”ä¸è¯´å­˜åœ¨å¤§é‡æ— ç”¨è®¡ç®—ï¼Œå½“åŒå±çš„ç‚¹å…‰æºè¾¾åˆ°æ•°ç™¾çº§åˆ«æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¤§å¯èƒ½åœ¨pixel shaderé‡Œå†™å‡º`for 100`è¿™ç§ä»£ç ã€‚

å¯¹è¿™ç§å±€éƒ¨å…‰æº(åŒ…æ‹¬Spot Light)çš„ä¼˜åŒ–æ€è·¯ï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯é€šè¿‡ä¸€ç§å«Light Volume Stencil Bufferçš„æ–¹å¼å»åšã€‚å…¶æ€è·¯å…¶å®è·ŸShadow Volumeæœ‰ç‚¹ç±»ä¼¼ï¼Œéƒ½æ˜¯åˆ©ç”¨Stencil Bufferå»æ¨¡æ‹Ÿè®¡ç®—è§†çº¿ç©¿è¿‡Light Volumeçš„æƒ…å†µã€‚å¦‚æœè§†çº¿å¯¹äºLight Volumeåªè¿›ä¸å‡ºï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªåƒç´ æ˜¯è¢«å…‰ç…§äº®çš„ï¼Œå¦åˆ™ä¸å—å…‰æºå½±å“ã€‚



![img](https://pic3.zhimg.com/80/v2-e4f8dfd0e57c94256632381709dbf26a_720w.webp)



å®Œæ•´çš„æ€è·¯å¯ä»¥çœ‹è¿™ç¯‡[[2\] Yuriy O'Donnell, Rendering deferred lights using Stencil culling algorithm, 2009](https://link.zhihu.com/?target=https%3A//kayru.org/articles/deferred-stencil/)

Light Volume + Stencil Bufferçš„æ–¹æ¡ˆç¼ºé™·åœ¨äºä¸€ä¸ªåƒç´ å¯èƒ½ä¼šäº§ç”Ÿå¤šæ¬¡å¯¹GBufferçš„è¯»å–ã€‚

URPçš„æœ€æ–°ç‰ˆæœ¬é‡Œä¹Ÿå®ç°äº†Deferred Shadingï¼Œç›®å‰æ˜¯ç”¨Light Volumeçš„æ–¹æ¡ˆå®ç°çš„ï¼Œæˆ‘ç„äº†ä¸€ä¸‹æºç ï¼Œå‘ç°Tile Basedæ–¹æ¡ˆä¹Ÿåœ¨è·¯ä¸Šäº†ï¼Œåªä¸è¿‡è¿˜æ²¡å¼€æ”¾å‡ºæ¥ã€‚

Tile Basedæ–¹æ¡ˆçš„æ€è·¯æ˜¯ï¼Œå°†å±å¹•åˆ†å‰²æˆè®¸è®¸å¤šå¤šçš„å°æ ¼å­ï¼Œç„¶åé’ˆå¯¹æ¯ä¸ªæ ¼å­åšå…‰æºå‰”é™¤ï¼Œè¿™æ ·å°±ä¸ºæ¯ä¸ªæ ¼å­å¾—åˆ°äº†Visible Lightsåˆ—è¡¨ã€‚åœ¨LightPassé˜¶æ®µï¼Œæˆ‘ä»¬åªè¦åˆ¤æ–­å½“å‰åƒç´ å±äºå“ªä¸ªæ ¼å­ï¼Œä»…ä¸å½“å‰æ ¼å­çš„ç¯å…‰åˆ—è¡¨åšå…‰ç…§è®¡ç®—å³å¯ã€‚

è¿™ä¸ªTile based Light Cullingï¼Œå³å¯ä»¥ç”±CPUåšï¼Œä¹Ÿå¯ä»¥ç”±GPUåšã€‚ä¾‹å¦‚URPä¸­æ­£åœ¨å®ç°çš„æ–¹æ¡ˆï¼Œæ˜¯ç”¨JobSystemå¤šçº¿ç¨‹CPUå»å‰”é™¤çš„ï¼Œå› ä¸ºURPè¿™ä¸ªç®¡çº¿çš„ç›®æ ‡å°±æ˜¯é€šç”¨åŒ–ï¼Œéœ€è¦ç…§é¡¾è®¾å¤‡å…¼å®¹æ€§ï¼Œå› æ­¤ä¸ä¼šé‡‡ç”¨ComputeShaderã€‚

åœ¨æ”¯æŒComputeShaderçš„GPUä¸Šï¼Œæ›´å¸¸è§çš„åº”è¯¥æ˜¯ä½¿ç”¨ComputeShaderè¿›è¡Œå…‰æºå‰”é™¤ã€‚è¿™ä¹Ÿæ˜¯æœ¬é¡¹ç›®çš„å®ç°æ–¹æ¡ˆã€‚

## 3. Tile based Light Culling

æ–¹æ¡ˆä¸»è¦å‚è€ƒä¸º[[3\] Johan Andersson, DirectX 11 Rendering in BF3, 2012](https://link.zhihu.com/?target=http%3A//developer.amd.com/wordpress/media/2012/10/GDC11_DX11inBF3.pdf)

æˆ‘ä»¬é¦–å…ˆä¼šä»CPUç«¯æä¾›ä¸€ä»½å…¨å±€ç‚¹å…‰æºä¿¡æ¯:

```text
StructuredBuffer<float4> _LightPositionAndRanges;
StructuredBuffer<half4> _LightColors;
uniform uint _LightCount
```

åŸºç¡€ç‰ˆæœ¬æµç¨‹å¦‚ä¸‹:

- å°†å±å¹•æŒ‰ç…§16x16 pixelåˆ†å—ï¼Œæ¯ä¸ªThreadGroupçš„çº¿ç¨‹æ•°é‡ä¹Ÿä¸º16x16x1ã€‚å› æ­¤æ¯ä¸ªThreadGroupå¯¹åº”ä¸€ä¸ªTileã€‚
- åœ¨Stage1ï¼Œæ¯ä¸ªThreadä»£è¡¨ä¸€ä¸ªåƒç´ ã€‚è¯»å–DepthTexture,ç„¶ååˆ©ç”¨InterlockedMin/InterlockedMaxå¯ä»¥è®¡ç®—å‡ºæ¯ä¸ªTileçš„Min/Max Depth
- åœ¨Stage2ï¼Œæ¯ä¸ªThreadä»£è¡¨ä¸€ä¸ªLightï¼Œå› æ­¤ä¸€æ¬¡æ€§å¯ä»¥è¿›è¡Œ16x16=256ç›ç¯å…‰ä¸Tileçš„ç›¸äº¤æµ‹è¯•ã€‚å¦‚æœè¶…å‡º256ï¼Œå°±forä¸€ä¸‹ã€‚
- åœ¨Stage3ï¼Œæ¯ä¸ªThreadä»£è¡¨ä¸€ä¸ªåƒç´ ï¼Œä¸stage2ä¸­ç”Ÿæˆçš„å…‰ç…§åˆ—è¡¨è¿›è¡Œç€è‰²è®¡ç®—ï¼Œå†™å…¥åˆ°RenderTextureä¸­ã€‚

æ¯ä¸ªThreadGroupåœ¨shareç©ºé—´å®šä¹‰å¦‚ä¸‹å˜é‡æ¥è®°å½•è¯¥tileçš„ç›¸äº¤å…‰æºç´¢å¼•:

```text
groupshared uint tileVisibleLightCount = 0;
groupshared uint tileVisibleLightIndices[MAX_LIGHT_COUNT];
```

å‰”é™¤è¿‡ç¨‹ç”¨ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹:

```text
[numthreads(THREAD_NUM_X,THREAD_NUM_Y,1)]
void CSMain (uint3 id : SV_DispatchThreadID,uint3 groupId:SV_GROUPID, uint groupIndex:SV_GROUPINDEX){

    //1. åˆå§‹åŒ–groupshared å˜é‡
    if(groupIndex == 0){
        InitGroupSharedVars();
    }
    GroupMemoryBarrierWithGroupSync();

    //2. è®¡ç®—tileçš„min/max depth
    InterlockedMin(tileDepthMin,asuint(linearDepth));
    InterlockedMax(tileDepthMax,asuint(linearDepth));
    GroupMemoryBarrierWithGroupSync();

    //3. åˆ‡æ¢åˆ°æ¯ä¸ªçº¿ç¨‹ä»£è¡¨ä¸€ä¸ªç¯å…‰ï¼Œä¸tileè¿›è¡Œæ±‚äº¤ï¼Œå¦‚æœç¯å…‰è¶…è¿‡256ï¼Œå°±åˆ†å¤šä¸ªpassè®¡ç®—
    uint passCnt = ceil(totalLightCount / THREAD_COUNT);
    for(uint passIdx = 0; passIdx < passCnt; passIdx ++){
        uint lightIndex = passIdx * THREAD_COUNT + groupIndex;
        if(lightIndex < totalLightCount){
            float4 lightSphere = _Lights[lightIndex];
            if(Intersect(tileFrustum,lightSphere)){
                uint offset;
                InterlockedAdd(tileVisibleLightCount,1,offset);
                tileVisibleLightIndices[offset] = lightIndex;
            }
        }
    }
    GroupMemoryBarrierWithGroupSync();

    //4. åˆ‡æ¢åˆ°æ¯ä¸ªçº¿ç¨‹ä»£è¡¨ä¸€ä¸ªåƒç´ ï¼Œè¿›è¡Œå…‰ç…§è®¡ç®—
    half4 color = 0;
    GBuffer gbuffer = ReadGBuffer(id.xy);
    for(uint i = 0;i < tileVisibleLightCount; i ++){
        LightInfo lightInfo = GetLightInfo(tileVisibleLightIndices[i]);
        color += PBRShading(gbuffer,lightInfo);
    }
    _OutTexture[id.xy] = color;
}
```

åœ¨åŸç‰ˆçš„æ–¹æ¡ˆé‡Œï¼Œå…‰ç…§ç€è‰²æ˜¯ç›´æ¥ç”¨Compute Shaderå®ç°çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨ä»¥ä¸Šçš„Light Cullingå®Œæˆä¹‹åï¼Œç›´æ¥åœ¨ComputeShaderé‡Œè¯»å–GBufferè¿›è¡Œå…‰ç…§ç€è‰²è®¡ç®—ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠå…‰ç…§å‰”é™¤ç»“æœå†™å…¥RWBufferåï¼Œäº¤ç»™Graphic Pipelineå»å®ç°å…‰ç…§ç€è‰²ã€‚

æœ¬é¡¹ç›®ä¸¤ç§æ–¹æ¡ˆéƒ½ä¼šè¿›è¡Œå®ç°ï¼Œåé¢ä¼šåŒæ­¥ç½—åˆ—ä¸€ä¸‹é‡åˆ°çš„é—®é¢˜ã€‚

## 3.1 åˆ†å—ç®—æ³•

æˆ‘ä»¬ä½¿ç”¨16x16 pixelä½œä¸ºä¸€å—ï¼Œé‚£ä¹ˆå±å¹•å¯ä»¥æ€»å…±è¢«åˆ†å‰²ä¸ºå¦‚ä¸‹å¤šå—ã€‚

```csharp
var screenWidth = camera.pixelWidth;
var screenHeight = camera.pixelHeight;
var tileCountX = Mathf.CeilToInt(screenWidth * 1f / tileSizeX);
var tileCountY = Mathf.CeilToInt(screenHeight * 1f / tileSizeY);
```

![img](https://pic4.zhimg.com/80/v2-9c91da9fd21e4bf40dcb1f8ae4f62b13_720w.webp)

ä¸ºäº†å»ºç«‹èµ·æ¯ä¸ªå—å¯¹åº”çš„è§†é”¥ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ‘„åƒæœºè¿‘å¹³é¢è¿›è¡Œç›¸åŒçš„åˆ†å‰²ã€‚

é¦–å…ˆæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°è¿‘å¹³é¢çš„å®½é«˜ä¿¡æ¯:

```csharp
var camera = cameraDes.camera;
var nearPlaneZ = camera.nearClipPlane;
var nearPlaneHeight = Mathf.Tan(Mathf.Deg2Rad * camera.fieldOfView  * 0.5f) * 2 * camera.nearClipPlane;
var nearPlaneWidth = camera.aspect * nearPlaneHeight;
```

ç„¶ååœ¨ViewSpaceæ‹¿åˆ°è¿‘å¹³é¢å·¦ä¸‹è§’åæ ‡:

```csharp
var CameraNearPlaneLB = new Vector3( - nearPlaneWidth/2,-nearPlaneHeight/2,nearPlaneZ);
```

ä»¥åŠè¿‘å¹³é¢æ°´å¹³å’Œå‚ç›´ä¸¤ä¸ªæ–¹å‘å‘é‡ï¼Œå‘é‡é•¿åº¦å¯¹åº”ä¸€ä¸ªTileçš„å¤§å°:

```csharp
var basisH = new Vector2(tileSizeX * nearPlaneWidth / screenWidth,0);
var basisV = new Vector2(0,tileSizeY * nearPlaneHeight / screenHeight);
```

è¿™æ ·æˆ‘ä»¬å°±èƒ½æ„å»ºå‡ºè¿‘å¹³é¢çš„Tileåˆ†å‰²

![img](https://pic1.zhimg.com/80/v2-6b9e21aa758be8b5e6a6a1713fdc31b0_720w.webp)

Near Plane Tileåˆ†å‰²

åˆ©ç”¨è§†é”¥ç›¸ä¼¼ä¸‰è§’å½¢çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥å¾—åˆ°æ¯ä¸ªTileå¯¹åº”çš„è¿œå¹³é¢çš„4ä¸ªé¡¶ç‚¹ã€‚

ä½†æ˜¯å¦‚æœç›´æ¥ä½¿ç”¨æ‘„åƒæœºè¿‘/è¿œå¹³é¢æ„å»ºTileè§†é”¥åŒ…å›´ç›’çš„è¯ï¼Œè£å‰ªæ•ˆç‡ä¸ä¼šå¾ˆé«˜ï¼Œ

![img](https://pic2.zhimg.com/80/v2-92500c263fc7dd9b58e3394a1c2686d5_720w.webp)

ä¾‹å¦‚åœ¨ä¸€ä¸ªTileè§†é”¥é‡Œï¼Œåœºæ™¯ç‰©ä½“å®é™…ä¸Šåªåˆ†å¸ƒäºå±€éƒ¨çš„æ·±åº¦èŒƒå›´ï¼Œå¦‚æœæˆ‘ä»¬ç”¨æ‘„åƒæœºçš„è¿‘/è¿œå¹³é¢æ„å»ºåŒ…å›´ç›’ä¸ç¯å…‰æ±‚äº¤ï¼Œå°±ä¼šå¾—åˆ°å¤§é‡æ— ç”¨çš„ç¯å…‰ï¼Œä¾‹å¦‚ä¸Šå›¾ä¸­çš„ç¯å…‰1å’Œç¯å…‰2ã€‚

ä¸ºäº†ä¼˜åŒ–è¿™ä¸ªé—®é¢˜ï¼Œäºæ˜¯å°±å¼•å…¥äº†Min/Max Depthè®¡ç®—ã€‚

## 3.2 ä¸ºæ¯ä¸ªTileè®¡ç®—Min/Max Depth

è¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œé¦–å…ˆGroupä¸­çš„æ¯ä¸ªçº¿ç¨‹ä»£è¡¨ä¸€ä¸ªåƒç´ ï¼Œä»DepthTextureä¸­è¯»å–å®ƒä»¬å¯¹åº”çš„æ·±åº¦å€¼ï¼Œä¸groupsharedå˜é‡è¿›è¡ŒInterlockedMin/InterlockedMaxè®¡ç®—å³å¯ã€‚æ³¨æ„è¿™é‡Œè¦å°†depthè½¬åˆ°LinearEyeSpaceã€‚

```text
bool inScreen = (float)id.x < _ScreenParams.x && (float)id.y < _ScreenParams.y;
//stage 2. è®¡ç®—tileçš„min/max depth
float depth = 0;
float linearDepth = 0;
if(inScreen){
    depth = _XDepthTexture[id.xy].r;
    #if UNITY_REVERSED_Z
    linearDepth = LinearEyeDepth(1 - depth);
    #else
    linearDepth = LinearEyeDepth(depth);
    #endif
    InterlockedMin(tileMinDepthInt,asuint(linearDepth));
    InterlockedMax(tileMaxDepthInt,asuint(linearDepth));
}
GroupMemoryBarrierWithGroupSync();
```

æœ‰äº†Min/Max Depthï¼Œæˆ‘ä»¬å°±çŸ¥é“äº†æ¯ä¸ªTileä¸­ç‰©ä½“çš„æ·±åº¦åˆ†å¸ƒæƒ…å†µ:

![img](https://pic1.zhimg.com/80/v2-d1bbb60dc9b64e39a217bfa3496bfd30_720w.webp)

æˆ‘ä»¬åˆ©ç”¨min/max depthä½œä¸ºTileè§†é”¥çš„è¿‘/è¿œå¹³é¢æ„å»ºåŒ…å›´ç›’ä¸ç¯å…‰æ±‚äº¤ï¼Œè¿™æ ·å°±èƒ½æ’é™¤æ‰å¾ˆå¤šæ— ç”¨çš„ç¯å…‰ã€‚

## 3.3 æ±‚äº¤è®¡ç®—

å¯¹äºç‚¹å…‰æºï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶å»ºç«‹çƒå½¢åŒ…å›´ç›’ã€‚å› æ­¤è¿™ä¸ªé—®é¢˜å°±ç­‰äºè§†é”¥ä½“ä¸çƒå½¢åŒ…å›´ç›’æ±‚äº¤è®¡ç®—ã€‚

é¦–å…ˆï¼Œç”±äºè¿‘/è¿œå¹³é¢æ˜¯åæ ‡è½´å¯¹é½çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¿«é€Ÿçš„é€šè¿‡zè½´å…ˆè¿›è¡Œç¬¬ä¸€éè¿‡æ»¤:

```text
//tileFrustumCornersæ˜¯tileè§†é”¥minDepthå¹³é¢çš„4ä¸ªé¡¶ç‚¹
bool Intersect(float3 tileFrustumCorners[4],float4 lightSphere){
    float tileDepthMin = asfloat(tileMinDepthInt);
    float tileDepthMax = asfloat(tileMaxDepthInt);
    float lightRadius = lightSphere.w;
    float lightDepthMin = lightSphere.z - lightRadius;
    float lightDepthMax = lightSphere.z + lightRadius;
    if(lightDepthMin > tileDepthMax || lightDepthMax < tileDepthMin){
        return false;
    }
    //....
}
```

æ¥ä¸‹æ¥å°±æ˜¯ä¾§æ–¹çš„4ä¸ªå¹³é¢ã€‚ä¸€ç§æ€è·¯æ˜¯ä¾æ¬¡è®¡ç®—çƒå¿ƒåˆ°4ä¸ªå¹³é¢çš„æœ‰å‘è·ç¦»ï¼Œçœ‹å…¶æ˜¯å¦å¤§äºçƒåŠå¾„ã€‚å¦‚æœæ˜¯ï¼Œé‚£ä¹ˆä¸ç›¸äº¤ï¼Œå¦åˆ™è®¤ä¸ºç›¸äº¤ã€‚

å•ä¸ªä¾§å¹³é¢ç›¸äº¤æ€§è®¡ç®—ä»£ç å¦‚ä¸‹:

```text
//p1,p2ä¸æ‘„åƒæœº(0,0,0)ä¸‰ç‚¹æ„æˆäº†è§†é”¥ä¾§å¹³é¢
bool IntersectSide(float3 p1,float3 p2,float4 lightSphere){
    float3 n = -normalize(cross(p1,p2));
    float d = dot(lightSphere.xyz,n);
    return d < lightSphere.w;
}
```

4ä¸ªå¹³é¢åˆèµ·æ¥å°±æ˜¯:

```text
IntersectSide(tileFrustumCorners[0],tileFrustumCorners[1],lightSphere)
&& IntersectSide(tileFrustumCorners[1],tileFrustumCorners[2],lightSphere)
&& IntersectSide(tileFrustumCorners[2],tileFrustumCorners[3],lightSphere)
&& IntersectSide(tileFrustumCorners[3],tileFrustumCorners[0],lightSphere);
```

å¦‚æœæˆ‘ä»¬æŠŠæ¯ä¸ªTileç›¸äº¤çš„ç¯å…‰æ•°é‡ç”¨ç°åº¦æ¸²æŸ“å‡ºæ¥ï¼Œæ•ˆæœå›¾å¦‚ä¸‹:

![img](https://pic2.zhimg.com/80/v2-1729980088c74b9482abf8f3773234ad_720w.webp)

å³å›¾ç°è‰²éƒ¨åˆ†è¡¨ç¤ºä¸ç¯å…‰ç›¸äº¤çš„Tile

å¯ä»¥å‘ç°å…¶å®è¯¯å·®è¿˜æ˜¯ä¸€äº›çš„ï¼Œåœ¨çƒä½“å¾ˆå¤§è€Œè§†é”¥å¾ˆå°çš„æƒ…å†µä¸‹ï¼Œ4ä¸ªè§’è½éƒ½ä¼šæˆä¸ºæ¼ç½‘ä¹‹é±¼ã€‚

![img](https://pic4.zhimg.com/80/v2-1cfa2c069958ab7b3f0588912fbd447f_720w.webp)

æ¼ç½‘ä¹‹é±¼

è­¬å¦‚ä¸Šå›¾çš„å·¦ä¸‹è§’ç»¿è‰²çš„Tileï¼Œ4ä¸ªå¹³é¢å‡ä¸çƒä½“ç›¸äº¤ï¼ˆä»æ•ˆç‡ä¸Šè€ƒè™‘ï¼Œæˆ‘ä»¬åªèƒ½åˆ¤å®šæ— é™å¤§å°çš„å¹³é¢ä¸çƒä½“æ˜¯å¦ç›¸äº¤ï¼‰ï¼Œä½†å®é™…ä¸Šè¿™ä¸ªtileä¸çƒä½“å¹¶ä¸ç›¸äº¤(å› ä¸ºå®é™…ä¸Šæ¯ä¸ªé¢å¤§å°æ˜¯æœ‰é™çš„)ã€‚

ä¸ºäº†ä¼˜åŒ–è¿™ä¸ªé—®é¢˜ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ¡ˆæ˜¯å¯¹tileè§†é”¥åœ¨xyå¹³é¢ä¸Šçš„æŠ•å½±å»ºç«‹åœ†å½¢åŒ…å›´ç›’ï¼Œç¤ºæ„å›¾å¦‚ä¸‹:

![img](https://pic4.zhimg.com/80/v2-5ffc5fa4eb98d5527788285baa51f923_720w.webp)

æŠ•å½±åˆ°xyå¹³é¢çš„åœ†å½¢åŒ…å›´ç›’



è“è‰²æ–¹å—ä¸ºminZå¹³é¢ï¼Œç»¿è‰²æ–¹å—maxZå¹³é¢ã€‚minZå’ŒmaxZçš„å®šä¹‰å¦‚ä¸‹:

```text
float minZ = max(tileDepthMin,lightDepthMin);
float maxZ = min(tileDepthMax,lightDepthMax);
```

æˆ‘ä»¬å°†minZ/maxZå¯¹åº”çš„ä¸¤ä¸ªå¹³é¢çš„å„è‡ª4ä¸ªé¡¶ç‚¹ï¼ŒæŠ•å½±åˆ°xyå¹³é¢åå»ºç«‹åœ†å½¢åŒ…å›´ç›’ã€‚åŒæ ·ç‚¹å…‰æºçš„çƒå½¢åŒ…å›´ç›’åœ¨xyå¹³å°ä¸Šçš„æŠ•å½±ä¹Ÿæ˜¯ä¸€ä¸ªåœ†å½¢ã€‚è¿™æ ·å°±æ²¦ä¸ºä¸¤ä¸ªåœ†å½¢ç›¸äº¤åˆ¤å®šã€‚

ä½†æ˜¯è®¡ç®—åœ†å½¢åŒ…å›´ç›’çš„è¯ï¼Œæ±‚åŠå¾„ä¼šæ¶‰åŠåˆ°å¼€æ–¹è¿ç®—ã€‚

æ‰€ä»¥è¿˜æœ‰ä¸€ç§æ›´å¿«é€Ÿçš„æ–¹æ¡ˆæ˜¯å¯¹æŠ•å½±åˆ°XYå¹³é¢çš„8ä¸ªé¡¶ç‚¹å»ºç«‹AABBåŒ…å›´ç›’ã€‚

![img](https://pic3.zhimg.com/80/v2-83aae34f089bde3454e1b24b27016336_720w.webp)

AABBåŒ…å›´ç›’



è¿™æ ·å°±æ²¦ä¸ºAABBä¸åœ†å½¢ç›¸äº¤åˆ¤å®šã€‚

è€ƒè™‘åˆ°æˆ‘ä»¬å½“å‰æƒ…å½¢é€šå¸¸æ˜¯åœ†å¾ˆå¤§ï¼ŒAABBå¾ˆå°ï¼Œå› æ­¤ç›¸äº¤ç®—æ³•æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è¿‘ä¼¼ä¸ºåˆ¤å®šAABBæ˜¯å¦æœ‰ä»»æ„ä¸€ä¸ªé¡¶ç‚¹ä½äºåœ†å½¢å†…ã€‚

å®é™…ä¸Šæˆ‘ä»¬å¹¶ä¸éœ€è¦çœŸçš„å¯¹æ¯ä¸ªé¡¶ç‚¹åšæ£€æµ‹ï¼Œè€Œæ˜¯é¦–å…ˆåˆ¤å®šåœ†å¿ƒä½äºAABB 4ä¸ªè±¡é™ä¸­çš„å“ªä¸ªï¼Œåªä¸å¯¹åº”è±¡é™çš„é¡¶ç‚¹åšåˆ¤å®šå°±è¡Œäº†ã€‚

AABBä¸åœ†ç›¸äº¤åˆ¤å®šä»£ç å¦‚ä¸‹:

```text
//aabb.xyä¸ºä¸­å¿ƒ,aabb.zwä¸ºextents
bool IntersectAABB(float4 aabb,float4 lightSphere){
    float2 p = aabb.xy + aabb.zw * sign(lightSphere.xy - aabb.xy);
    float2 d = p - lightSphere.xy;
    return dot(d,d) < lightSphere.w * lightSphere.w;
}
```

æ”¹è¿›åçš„tile visible lights debugæ•ˆæœ:

![img](https://pic3.zhimg.com/80/v2-5d362b6f7ebc661d77d811fb242ba0fa_720w.webp)

AABB-Circle Intersect

## 3.4 Depth Slice

éšæœºåœ¨åœºæ™¯é‡Œç”Ÿæˆ256ç›Point Lightï¼Œçœ‹çœ‹æ•ˆæœå›¾ã€‚

![img](https://pic2.zhimg.com/80/v2-995979f79d1901eeae83174f1836f1dd_720w.webp)

ç„¶åè¾“å‡ºæ¯ä¸ªtileçš„VisibleLightCountï¼Œè¿›è¡Œdebugä¸€ä¸‹

![img](https://pic3.zhimg.com/80/v2-b32222f57549a27b9db6d69ea9965f56_720w.webp)

è¶Šç™½è¡¨ç¤ºè¿™ä¸ªtileç›¸äº¤çš„ç¯å…‰æ•°é‡è¶Šå¤š

æˆ‘ä»¬ä¼šå‘ç°ç‰©ä½“çš„è¾¹ç¼˜ç‰¹åˆ«ç™½ã€‚è¿™æ˜¯å› ä¸ºç‰©ä½“è¾¹ç¼˜çš„tileï¼Œå…¶min/max depthä¹‹å·®æ¯”è¾ƒå¤§ï¼Œå› æ­¤ç›¸äº¤çš„å…‰æºæ›´å¤šã€‚

ä¸ºäº†æ›´è¿›ä¸€æ­¥ä¼˜åŒ–è¿™ä¸ªé—®é¢˜ï¼Œæ’é™¤æ— æ•ˆçš„ç¯å…‰ï¼Œä¸€ç§æ–¹æ¡ˆæ˜¯å¯¹æ·±åº¦è¿›è¡Œåˆ†å‰²ã€‚

æ¥è‡ª - [[4\] Takahiro Harada, A 2.5D CULLING FOR FORWARD+, 2012](https://link.zhihu.com/?target=https%3A//e8040b55-a-62cb3a1a-s-sites.googlegroups.com/site/takahiroharada/storage/2012SA_2.5DCulling.pdf)

å…¶åŸç†ä¸ºï¼Œåœ¨min/max depthè®¡ç®—ç»“æŸåï¼Œå°†å…¶åˆ‡å‰²æˆ32ä»½(ç¤ºæ„å›¾åªç»™äº†8ä»½)ã€‚

![img](https://pic2.zhimg.com/80/v2-ef49cd097c730ae40dca6af7e38b5f9d_720w.webp)

depth slice

æˆ‘ä»¬ä¸ºä¸€ä¸ªtileå®šä¹‰ä¸€ä¸ª`groupshared uint gemoDepthMask`ï¼Œæ¥è®°å½•è¿™ä¸ªtileä¸­åƒç´ åœ¨32ä»½åŒºé—´ä¸­çš„åˆ†å¸ƒæƒ…å†µã€‚æ¯ä¸ªbitä»£è¡¨ä¸€ä¸ªåŒºé—´ï¼Œå¦‚æœæ˜¯1ï¼Œå°±è¡¨ç¤ºæœ‰åƒç´ è½å…¥è¿™ä¸ªåŒºé—´ï¼Œ0åˆ™è¡¨ç¤ºæ²¡æœ‰åƒç´ è½å…¥è¿™ä¸ªåŒºé—´ã€‚

gemoDepthMaskç”Ÿæˆä»£ç å¦‚ä¸‹:

```text
float depthSliceInterval = max(0.01,(tileDepthMax - tileDepthMin) / 32.0);
uint depthSliceIndex = floor((linearDepth -  tileDepthMin) / depthSliceInterval);
InterlockedOr(gemoDepthMask,1 << depthSliceIndex);
GroupMemoryBarrierWithGroupSync();
```

ç„¶ååœ¨ç¯å…‰ç›¸äº¤è®¡ç®—é˜¶æ®µï¼ŒåŒæ ·ä¸ºç¯å…‰ç”Ÿæˆä¸€ä¸ªlightDepthMask:

![img](https://pic4.zhimg.com/80/v2-76d737221b34e144ac8f97a234e68b7f_720w.webp)

light depth mask

å°†lightDepthMaskä¸gemoDepthMaskæŒ‰ä½andï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™ç¯å…‰ä¸tileä¸ç›¸äº¤ã€‚

è¿™ä¸ªæ–¹æ¡ˆä»¥è¾ƒå°çš„ä»£ä»·ï¼Œæ’é™¤äº†é‚£äº›ä½äºä¸¤ä¸ªç‰©ä½“ä¹‹é—´ï¼Œåˆä¸ä¸ç‰©ä½“äº¤äº’çš„ç¯å…‰ã€‚

åœ¨åŠ å…¥depth sliceåŠŸèƒ½åï¼Œtile visible light count debugæ•ˆæœå¦‚ä¸‹:

![img](https://pic4.zhimg.com/80/v2-f4fb2e1c8e11efab7812b4a826024a9b_720w.webp)

intersect with depth slice

å¾ˆæ˜æ˜¾ï¼Œè¾¹ç¼˜æ²¡æœ‰é‚£ä¹ˆç™½äº†ã€‚

## 4. ä¸€äº›é—®é¢˜ç½—åˆ—

æ¥ä¸‹æ¥è¯´ä¸€ä¸‹å®ç°è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜å§ã€‚

## 4.1 ComputeShaderç€è‰²çš„é—®é¢˜

é¦–å…ˆä¸€å¼€å§‹æˆ‘ä½¿ç”¨äº†ComptueShaderè¿›è¡Œç€è‰²ã€‚ä½¿ç”¨CSè¿›è¡Œç€è‰²çš„å¥½å¤„æ˜¯æ•´ä¸ªæµç¨‹å¾ˆé¡ºï¼Œæ— éœ€å°†ä¿å­˜åœ¨groupsharedç©ºé—´çš„ç¯å…‰å‰”é™¤ä¿¡æ¯å†™å…¥åˆ°Bufferä¸­ï¼Œå†æ¥ä¸€æ¬¡LightPassç»˜åˆ¶ã€‚

åå¤„åˆ™æ˜¯åœ¨Mobileç«¯å¯èƒ½æ— æ³•åˆ©ç”¨On-Chip Memoryã€‚æ ¹æ®è‹¹æœåœ¨[[5\] Apple, rendering_a_scene_with_deferred_lighting_in_c](https://link.zhihu.com/?target=https%3A//developer.apple.com/documentation/metal/rendering_a_scene_with_deferred_lighting_in_c)ä¸­æ‰€è¿°ï¼Œå…¶å¯ä»¥åˆ©ç”¨on-chip memoryå®ç°one passçš„deferred shadingï¼ŒComputeShaderå¥½åƒæ²¡æœ‰è¿™ä¸ªæ¦‚å¿µå§ï¼Ÿåº”è¯¥åªèƒ½ç›´æ¥ä»System Memoryè¯»å–GBuffer.

å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœåˆ©ç”¨ComputeShaderè¿›è¡Œç€è‰²ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºå…¶æä¾›ä¸€å¼ Random Write Onçš„RenderTextureã€‚æˆ‘å‘ç°å®é™…æ¸²æŸ“å‡ºæ¥ä¼šæœ‰å¾ˆæ˜æ˜¾çš„æ¸å˜æ¡çº¹:

![img](https://pic3.zhimg.com/80/v2-0ea04b56787dd68aac690a71145a0a5a_720w.webp)

å¯¹Random Write Onçš„RTè¿›è¡Œæ¸²æŸ“å‡ºç°æ˜æ˜¾çš„æ¸å˜æ¡çº¹

è¿™ä¸ªå¯ä»¥ç†è§£ï¼Œå› ä¸ºå¯¹äºä¸€å¼ RGBA32çš„å›¾ï¼Œæ¯ä¸ªåˆ†é‡8bitï¼Œåªèƒ½æä¾›256é˜¶çš„äº®åº¦è¡¨ç°ã€‚ä»¥ä¸Šçš„æ¸å˜æ¡çº¹å®é™…ä¸Šç›¸å½“äºä»¥ä¸‹çš„ä»£ç :

```text
_OutTexture[xy] = floor(color * 255) / 255.0;
```

åŒæ ·çš„ï¼Œå½“æˆ‘å°†Graphic Pipelineçš„RenderTargetè®¾ç½®æˆRandom Write Onï¼Œä¹Ÿæ˜¯ä¼šå‡ºç°è¿™æ ·çš„æ¸å˜æ¡çº¹ã€‚ä½†æ˜¯å…³é—­Random Writeåï¼Œæ¸å˜å°±å¾ˆæµç•…äº†ã€‚

![img](https://pic1.zhimg.com/80/v2-5532066dfba029e8f5541e0f2581bb14_720w.webp)

Random Write Off åˆ™ä¸ä¼šå‡ºç°æ¸å˜æ¡çº¹

æš‚ä¸æ¸…æ¥šä»€ä¹ˆåŸå› ã€‚ã€‚

## 4.2 æ¯ä¸ªTileæœ€å¤§ç¯å…‰æ•°é™åˆ¶é—®é¢˜

é€šå¸¸ä¸ºäº†é¿å…æç«¯æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯ä¸ªtileçš„æœ€å¤§ç¯å…‰æ•°é‡è¿›è¡Œé™åˆ¶ã€‚ä½†æ˜¯è¿›è¡Œé™åˆ¶åï¼Œå¦‚æœä¸€ä¸ªtileçš„å®é™…visible lightsè¶…è¿‡äº†maxè¢«ä¸¢å¼ƒä¸€éƒ¨åˆ†åï¼Œä¼šå‡ºç°é—ªçƒé—®é¢˜ã€‚

è¿™æ˜¯å› ä¸ºtileä¸å…‰æºæ±‚äº¤è®¡ç®—çš„æ—¶å€™æ˜¯å¹¶è¡Œè®¡ç®—çš„ï¼Œå“ªä¸ªç¯å…‰å…ˆå®Œæˆæ±‚äº¤è®¡ç®—ï¼Œå“ªä¸ªå°±ä¼˜å…ˆè¿›å…¥åˆ°visible lightsé˜Ÿåˆ—é‡Œã€‚å› æ­¤æ¯æ¬¡ç”Ÿæˆçš„visible lightsåˆ—è¡¨éƒ½æœ‰ä¸€å®šéšæœºæ€§ï¼Œå°±äº§ç”Ÿäº†é—ªçƒã€‚

ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯å¯¹æ¯ä¸ªtileçš„visible lightsè¿›è¡Œé‡è¦æ€§æ’åºï¼Œä½†è¿™åˆæ¶‰åŠåˆ°GPUå¹¶è¡Œæ’åºäº†ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚

æˆ‘çœ‹ç›¸å…³çš„èµ„æ–™éƒ½æ²¡æœ‰æåˆ°è¿™ä¸ªé—®é¢˜ï¼Œéš¾é“æ˜¯æˆ‘çš„å®ç°æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

## 4.3 å…³äºMobileä¸Šçš„Deferred Shading

Appleåœ¨[5]é‡Œæåˆ°äº†One Pass Deferred Shadingï¼Œå³å°†GBufferä¿å­˜åˆ°OnChipMemoryä¸Šï¼Œè¿™æ ·å°±è§£å†³äº†Deferred Shadingå­˜åœ¨çš„å¸¦å®½é—®é¢˜ã€‚ç›®å‰æš‚ä¸çŸ¥é“Unityæ˜¯å¦æ”¯æŒè¿™ä¸ªåŠŸèƒ½ã€‚

## 4.4 å…³äºForward+çš„ä¸€äº›æƒ³æ³•

Tile based Light CullingåŒæ ·å¯ä»¥ä¸Forwardè¿›è¡Œç»“åˆï¼Œå¾—åˆ°Forward+ã€‚å¯¹äºæ”¯æŒHSRçš„è®¾å¤‡(Hidden Surface Removal)ï¼Œé¦–å…ˆå·²ç»ä¸å­˜åœ¨Overdrawçš„é—®é¢˜äº†ï¼Œå‡å¦‚æˆ‘ä»¬ä½¿ç”¨ä¸Šä¸€å¸§çš„depthTextureæ¥åšTile Light Culingï¼Œé‚£ä¹ˆForward+çš„ä¼˜åŠ¿æ˜¯å¦è¦æ¯”Tile based Deferred Shadingé«˜å¾ˆå¤šå‘¢ï¼Ÿ

## 4.5 å…³äºComputeShader multi_compileçš„è¯´æ˜

unityåœ¨2020ç‰ˆæœ¬ä¸ºComputeShaderå¢åŠ äº†multi_compileæ”¯æŒï¼Œæœ¬é¡¹ç›®ä¸ºäº†åšå„ç§æ–¹æ¡ˆå¯¹æ¯”å› æ­¤åŠ äº†å¾ˆå¤šmulti_compileé€‰é¡¹ã€‚åœ¨å®é™…äº§å“ä¸­åº”å½“å°½é‡å‡å°‘å…¨å±€çš„multi_compileï¼Œè€Œæ˜¯ä½¿ç”¨shader_featureæ¥ä»£æ›¿ï¼Œå¦åˆ™shaderå˜ç§ç»„åˆå°†çˆ†ç‚¸å¼å¢é•¿ã€‚

## Reference

[[1\] A Survey of Efficient Representations for Independent Unit Vectors, 2014](https://link.zhihu.com/?target=http%3A//jcgt.org/published/0003/02/01/paper.pdf)

[[2\] Yuriy O'Donnell, Rendering deferred lights using Stencil culling algorithm, 2009](https://link.zhihu.com/?target=https%3A//kayru.org/articles/deferred-stencil/)

[[3\] Johan Andersson, DirectX 11 Rendering in BF3, 2012](https://link.zhihu.com/?target=http%3A//developer.amd.com/wordpress/media/2012/10/GDC11_DX11inBF3.pdf)

[[4\] Takahiro Harada, A 2.5D CULLING FOR FORWARD+, 2012](https://link.zhihu.com/?target=https%3A//e8040b55-a-62cb3a1a-s-sites.googlegroups.com/site/takahiroharada/storage/2012SA_2.5DCulling.pdf)

[[5\] Apple, rendering_a_scene_with_deferred_lighting_in_c](https://link.zhihu.com/?target=https%3A//developer.apple.com/documentation/metal/rendering_a_scene_with_deferred_lighting_in_c)



## é¡¹ç›®åœ°å€

[GitHub - wlgys8/SRPLearn at 11_deferred_rendering](https://link.zhihu.com/?target=https%3A//github.com/wlgys8/SRPLearn/tree/11_deferred_rendering)